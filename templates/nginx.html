{% extends "base.html" %}

{% block content %}
  <header class="page-header">
    <div>
      <h1>Nginx Reverseproxy</h1>
      <p class="muted">VHosts erstellen, Defaults verwalten und bestehende Einträge bearbeiten.</p>
    </div>
  </header>

  <section class="card">
    <h2>Globale Defaults</h2>
    <form method="post" action="{{ url_for('nginx_defaults_route') }}">
      <label>
        Default Upstream URL
        <input
          name="upstream_url"
          placeholder="http://service:8080"
          value="{{ defaults.upstream_url }}"
          list="upstream-suggestions"
        />
      </label>
      <label class="checkbox">
        <input type="checkbox" name="redirect_http" {% if defaults.redirect_http %}checked{% endif %} />
        HTTP → HTTPS umleiten
      </label>
      <button type="submit">Defaults speichern</button>
    </form>
    {% if upstream_suggestions %}
      <datalist id="upstream-suggestions">
        {% for item in upstream_suggestions %}
          <option value="{{ item.url }}">{{ item.label }}</option>
        {% endfor %}
      </datalist>
    {% endif %}
  </section>

  <section class="card">
    <h2>VHost erstellen</h2>
    <form method="post" action="{{ url_for('nginx_create_route') }}">
      <label>
        Domain (primär)
        <input name="primary_domain" placeholder="example.com" required />
      </label>
      <label>
        Weitere Domains (CSV, optional)
        <input name="extra_domains" placeholder="www.example.com, *.example.com" />
      </label>
      <label>
        Upstream URL
        <input
          name="upstream_url"
          placeholder="http://service:8080"
          value="{{ defaults.upstream_url }}"
          list="upstream-suggestions"
          required
        />
      </label>
      <label>
        Zertifikat auswählen
        <select name="cert_choice" required>
          <option value="">Bitte wählen</option>
          {% for item in certificates %}
            <option value="{{ item.label }}">{{ item.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="checkbox">
        <input type="checkbox" name="redirect_http" {% if defaults.redirect_http %}checked{% endif %} />
        HTTP → HTTPS umleiten
      </label>
      <button type="submit">VHost erstellen</button>
    </form>
  </section>

  <section class="card">
    <h2>Vorhandene VHosts</h2>
    {% if vhosts %}
      <div class="table vhost-table">
        <div class="table-row table-head">
          <div>Name</div>
          <div>Domains</div>
          <div>Upstream</div>
          <div>RAW</div>
          <div>Aktionen</div>
        </div>
        {% for item in vhosts %}
          <div class="table-row">
            <div>{{ item.display_name or item.name }}</div>
            <div>{{ item.server_names | join(", ") }}</div>
            <div>{{ item.upstream_url }}</div>
            <div>
              <details class="raw-details">
                <summary class="button-secondary">Anzeigen</summary>
                <div class="code-block">{{ item.raw_content | e }}</div>
              </details>
            </div>
            <div class="inline-actions">
              <a class="button-secondary" href="{{ url_for('nginx_edit_route', name=item.name) }}">Bearbeiten</a>
              <form class="inline-form" method="post" action="{{ url_for('nginx_delete_route', name=item.name) }}">
                <button class="button-danger" type="submit">Löschen</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Noch keine VHosts vorhanden.</p>
    {% endif %}
  </section>

  <section class="card">
    <h2>Vorhandene Domains</h2>
    {% if domains %}
      <div class="tag-list">
        {% for domain in domains %}
          <span class="tag">{{ domain }}</span>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Keine Domains gefunden.</p>
    {% endif %}
  </section>

  <section class="card">
    <h2>Lokale Container</h2>
    {% if containers %}
      <div class="table">
        <div class="table-row table-head">
          <div>Name</div>
          <div>Image</div>
          <div>Status</div>
          <div>Ports</div>
          <div>Upstream</div>
        </div>
        {% for item in containers %}
          <div class="table-row">
            <div>{{ item.name }}</div>
            <div>{{ item.image }}</div>
            <div>{{ item.status }}</div>
            <div>
              {% if item.ports %}
                {% for port in item.ports %}
                  <div>{{ port.private }}{% if port.public %} → {{ port.public }}{% endif %} {{ port.type }}</div>
                {% endfor %}
              {% else %}
                <span class="muted">-</span>
              {% endif %}
            </div>
            <div>
              {% if item.ports %}
                {% for port in item.ports %}
                  {% if port.type == 'tcp' and port.private %}
                    <div class="code-inline">http://{{ item.name }}:{{ port.private }}</div>
                  {% endif %}
                {% endfor %}
              {% else %}
                <span class="muted">-</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Keine Container gefunden (oder kein Zugriff auf Docker Socket).</p>
    {% endif %}
  </section>
{% endblock %}
